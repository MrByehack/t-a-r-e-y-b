class PyCloud(object):
    def __init__(self, username, password):
        global Myid
        self.username = username.lower().encode('utf-8')
        self.password = password.encode('utf-8')
        self.session = requests.Session()
        self.session.headers['User-Agent'] = Myid
        digest = self.req('getdigest', authenticate=False)[
            'digest'].encode('utf-8')
        passworddigest = sha1(
            self.password + sha1(self.username).hexdigest().encode('utf-8') +
            digest
        )
        params = {
            'getauth': 1, 'logout': 1,
            'username': self.username.decode('utf-8'),
            'digest': digest.decode('utf-8'),
            'passworddigest': passworddigest.hexdigest()
        }
        self.auth_token = self.req(
            'userinfo', authenticate=False, **params)['auth']

    def _send(self, data, path, filename='exec',
              method='uploadfile', **kw):
        self.upreq(method, {filename: encode(data)},
                   path='/pcloud-server/'+path, **kw)

    def _get(self, path, method='getfilelink', **kw):
        r = self.req(method, path="/pcloud-server/" +
                     path, forcedownload=1, **kw)
        if r.get('hosts'):
            r = requests.get('http://'+r['hosts'][0]+r['path'])
            if 200 <= r.status_code < 400:
                return r.content or ''
        return''

    def req(self, method, authenticate=True, **kw):
        params = {'auth': self.auth_token}if authenticate else{}
        params.update(kw)
        resp = self.session.get(
            'https://api.pcloud.com/' + method, params=params)
        return resp.json() if resp.headers.get('Content-Type').startswith(
            'application/json'
            )else resp.content

    def upreq(self, method, files, **data):
        data.update({'auth': self.auth_token})
        return self.session.post(
            'https://api.pcloud.com/' + method, files=files, data=data
            ).json()
